### 为什么DB连接管理一般不采用IO多路复用？
作者：大宽宽
链接：https://www.jianshu.com/p/61079795896b
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

#### IO多路复用？

IO多路复用听上去好像是多个数据可以共享一个IO（socket连接），实际上并非如此。

IO多路复用不是指多个服务共享一个连接，而仅仅是指多个连接的管理可以在同一进程。

对于使用DB的程序来讲，不管使用多路复用，还是连接池，都要维护一组网络连接，支持并发的查询。

#### 为什么并发查询一定要使用多个连接才能完成呢？

因为DB一般是使用连接作为Session管理的基本单元。

在一个连接中，SQL语句的执行必须是串行、同步的。这是由于对于每一个Session，DB都要维护一组状态来支持查询，比如事务隔离级别，当前Session的变量等。只有单Session内串行执行，才能维护查询的正确性。

维护这些状态需要耗费内存，同时也会消耗CPU和磁盘IO。这样，限制对DB的连接数，就是在限制对DB资源的消耗。

因此，对DB来说，关键是要限制连接的数目。这个要求无论是DB连接池还是NIO的连接管理都能做到。

#### 为什么DB连接不能放到IO多路复用里一并执行吗？

答案是，可以用IO多路复用——但是使用JDBC不行。

当然如果DB Client的协议的连接处理和解析稍微改一下：

将IO模式调整为Non-Blocking，这样就可以挂到IO多路复用的内核上（select、epoll、kqueue……）

在Non-Blocking实现的基础之上实现数据库协议的编码和解析

就可以实现用IO多路复用来访问DB。实际上很多其他语言/框架里都是这么干的。只不过对于IO多路复用，数据库官方似乎都没做这种支持——他们只支持JDBC、ODBC等等这些标准协议。

#### 那么为什么基于IO多路复用的实现不能成为默认的，官方的，而要成为偏门呢？

（1）对于数据库开发者来说。这种用法在整体的用户里占有量非常小，所以也许不值当的花大力气。

只需要把协议写清楚（比如https://dev.mysql.com/doc/internals/en/client-server-protocol.html），就可以做实现。那么社区的有兴趣的人自然就可以去做。

（2）另外一个原因是体系的支持。

简单来讲，如果没有一个大的Reactive的运行环境，IO多路复用的使用会非常受限。

IO多路复用之所以能成立，是需要整个程序要有一个IO多路复用的驱动代码——就是select那调用——等待事件来临，一个blocking的API。整个程序必须以这个驱动代码为核心。这样就对整个代码的结构产生重大的影响。这种影响是没法用简单的接口抽象的。

Java Web容器之所以可以使用NIO是因为NIO可以被封装到容器内部。Web容器对外暴露的还是传统的多线程形式的Java EE接口。

如果DB和Web容器同时使用NIO，那么调用的DB连接库必须与容器有一个约定描述DB的连接管理如何接入Web容器的NIO的驱动代码。在Java这个大环境下，不同人，不同的容器写的代码不同；又或者，不使用任何常见的容器，而是自己用NIO去封装一个。这样是无法形成代码上的约定的。那么多个独立的组件就不能很好的共享NIO的驱动代码。

（3）相反，连接池的实现就相对独立的多，也简单的多。

外界只要配好DB URL，用户名密码和连接池的容量参数，就可以做到自行管理连接。

（4）最后，有大量场景是需要BIO的DB查询支持的。

批处理数据分析代码都是这样的场景。

#### 总结一下

（1）DB访问一般采用连接池这种现象是生态造成的。

（2）历史上的BIO+连接池的做法经过多年的发展，已经解决了主要的问题。在Java的大环境下，这个方案是非常靠谱的，成熟的。

（3）而基于IO多路复用的方式尽管在性能上可能有优势，但是其对整个程序的代码结构要求过多，过于复杂。

（4）当然，如果有特定的需要，希望使用IO多路复用管理DB连接，是完全可行的。