### A Primer on Memory Consistency and Cache Coherence, Second Edition

Vijay Nagarajan, Daniel J. Sorin, Mark D. Hill, and David A. Wood

### 1. Introduction to Consistency and Coherence

Memory Consistency （内存一致性模型）是对共享内存正确性的一个精确的、在架构上可见的定义。Memory Consistency 定义提供了关于加载和存储（或内存读写）以及它们如何对内存进行操作的规则，而不依赖缓存。

Cache Coherence （缓存一致性协议） 是支持 Memory Consistency （内存一致性模型）的一种手段。在带有缓存的共享内存系统中，当其中一个处理器更新其缓存值时，缓存的值可能会过时（或不一致）。Cache Coherence 试图使共享内存系统的缓存在功能上与单核系统中的缓存保持一致：通过将处理器的写入传播到其他处理器的缓存。

Memory Consistency 可以使共享内存看起来像一个独立的内存模块。Cache Coherence 使缓存变得透明（使用者不用关心细节，就像不存在一样）。

Memory Consistency （内存一致性模型）和 Cache Coherence （缓存一致性协议）是复杂而微妙的。 然而，必须对这种复杂性进行管理，以确保多核是可编程的，并且它们的设计可以被验证。

### 2. Coherence Basics

理论上，处理器一次可以存取动态大小（一般是 1-64 字节）的数据。实际上，为了保证良好的存取效率，加载的数据一般为缓存块的大小。

缓存一致性的另一层定义：满足以下 2 个不变式约束：
（1）活性：每个存储单元最终对所有处理器可见
（2）安全性：在同一个存储单元的操作可被序列化（每个处理器看见的次序都是一致的）

### 3. Memory Consistency Motivation and Sequential Consistency

内存一致性模型，或内存模型，是多线程程序使用共享内存执行时允许的行为规范。多线程程序使用特定输入数据执行，与单线程执行不同，通常允许多个正确的行为。

Leslie Lamport 提出了顺序一致性的概念，顺序一致性要求方法调用的执行行为具有按照某种顺序次序的执行效果，并且这种顺序执行的次序应该与程序次序保持一致。

在任意的并发执行中，都存在一种办法使得方法调用按照某种顺序次序排序，并且这种顺序次序
（1）与程序次序相一致
（2）满足对象的顺序规范说明

可以有多种调用次序满足这个条件。

### 4. Total Store Order and the x86 Memory Model

写操作很常见，引入写缓冲区可以有效的提升性能，但是带来了一致性问题。

一个广泛实现的内存一致性模型是 Total Store Order（TSO）。TSO 最初是由 SPARC 引入的，更重要的是，它似乎与广泛使用的 x86 架构的内存一致性模型相匹配。

顺序一致性（SC）满足：
（1）Load -> Load
（2）Load -> Store
（3）Store -> Store
（4）Store -> Load

但 TSO 对 Store -> Load 不做要求（更加宽松），因此处理器可以使用写入缓冲区（必须是 FIFO，否则不满足 Store -> Store 约束）。在大多数情况下，TSO 的行为与 SC 没有区别。此外，大多数当前的 TSO 实现似乎只使用上述方法：采取 SC 实现并使用写缓冲区。

注意：TSO 写缓冲区在逻辑上对每个线程上下文（虚拟处理器）都是私有的。因此，在多线程处理器上，写缓冲区是互不干扰的。

为了解决写缓冲带来的不一致问题（不满足 Store -> Load），可以使用 FENCE 指令来强制保证次序（换句话说，SC 的每个操作前后，都加了 FENCE 指令）。

什么是好的内存模型？ 一个好的内存一致性模型应该有 4 个 P：

（1）Programmability（可编程性）：直观的，容易编写多线程程序

（2）Performance（性能）：能够被高性能地实现

（3）Portability（可移植性）：被广泛采用，或者提供向后兼容的能力

（4）Precision（精确性）:精确地定义，通常是用数学来定义的

### 5. Relaxed Memory Consistency

### 原文链接

#### 1. [第一版 and Coherence]A Primer on Memory Consistency and Cache Coherence

https://1lib.net/book/1220136/0f72be

#### 2. [第二版]A Primer on Memory Consistency and Cache Coherence, Second Edition

https://1lib.net/book/5526100/1f9ea9
