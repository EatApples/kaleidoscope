### 一. 负载均衡
#### 1. `DNS`（`Domain Name System`）
`DNS`即域名系统，其作用是将字符串域名解析成相对应的机器`IP`。

可以通过设置，将域名映射到多个服务器的`IP`。客户端使用的是系统的域名，`DNS`采用一种轮询的方式， `客户端1`的机器做域名解析的时候，`DNS`返回`IP1`；`客户端2`的机器做域名解析的时候，`DNS`返回`IP2`，以此实现各个机器的负载相对均衡。

缺陷：由于`DNS`这个分层的系统中有缓存，客户端的机器也有缓存，如果某个机器出故障，域名解析仍然会返回那个出问题机器的`IP`，那所有访问该机器的客户端都会出问题， 即使我们把这个机器的`IP`从`DNS`中删除也不行， 这就麻烦了。

#### 2. `LVS`（`Linux Virtual Server`）
`LVS`是章文嵩博士在1998年5月成立的自由软件项目，现在已经是`Linux`内核的一部分。

`LVS`支持三种负载工作方式：`NAT`方式、`DR`方式和`TUN`方式。

##### 2.1 `NAT`（地址转换）
`NAT`模型其实就是通过网络地址转换来实现负载均衡的。下面是它的流程：

（1）客户端（源地址为`CIP`）请求`Load Balancer`（目标地址为`VIP`）

（2）`Load Balancer`收到客户端的请求，发现源地址为`CIP`，请求的目标地址为`VIP`，那么`Load Balancer`会根据此前设定好的调度算法将客户端请求负载给某台`RS`（实际服务）。`Load Balancer`通过将客户端请求报文中的目标地址，从原来的`VIP`改为`RS`的`IP`，然后再转发给`RS`

（3）`RS`收到客户端的请求，处理好请求后会将一个源地址为自己，目标地址为`CIP`的数据包通过`Load Balancer`发出去

（4）当`Load Balancer`收到一个源地址为`RS`的`IP`，目标地址为`CIP`的数据包，此时`Load Balancer`会将源地址修改为`VIP`，然后再将数据包发送客户端

数据的流向：
```
客户端 --> Load Balancer --> RS --> Load Balancer --> 客户端
```

瓶颈：所有的流量都要通过`Load Balancer`，`Load Balancer`要修改客户端发来的数据包， 还要修改发给客户端的数据包。

##### 2.2 `DR`（直接路由）
`DR`模型在只有请求的时候才会经过`Load Balancer`， 回应的数据包由`RS`直接响应，客户端不需要经过`Load Balancer`。

下面是它的工作流程：

（1）客户端（源地址为`CIP`）请求`Load Balancer`（目标地址为`VIP`）

（2）不管是`Load Balancer`还是`RS`上都需要配置`VIP`，那么当客户端请求到达集群网络的前端路由器的时候，`IP`数据包的源地址为`CIP`，目标地址为`VIP`，此时路由器会发广播问谁是`VIP`。谁先响应路由器那么路由器就会将客户端请求发给谁，这样一来集群系统就没有意义了。可以在网关路由器上配置静态路由指定`VIP`就是`Load Balancer`，或者使用一种机制不让`RS`接收来自网络中的`ARP`地址解析请求，这里只让`Load Balancer`响应这个`VIP`地址的`ARP`请求。这样一来客户端的`IP`数据包都会经过`Load Balancer`。既然`Load Balancer`得到了这个客户端的`IP`数据包，它就可以用某个策略选取一个`RS`，把`IP`数据包原封不动，封装成数据链路层的包（注意，`IP`数据包其实是通过数据链路层发过来的。这里将数据帧中的目标`MAC`地址修改为`RS`的`MAC`地址），直接转发就可以了


（3）当`RS`收到一个源地址为`CIP`目标地址为`VIP`的数据包时，`RS`发现目标地址为`VIP`，而`VIP`就是自己，于是接受数据包并给予处理。当`RS`处理完请求后，会将一个源地址为`VIP`，目标地址为`CIP`的数据包发出去，此时的响应请求就不会再经过`Load Balancer`了，而是直接响应给客户端

数据的流向：
```
客户端 --> Load Balancer --> RS --> 客户端
```

##### 2.3 `TUN`（隧道）
`TUN`的工作机制跟`DR`一样，只不过在转发的时候，它需要重新包装`IP`报文。这里的`RS`离得都比较远。用户请求以后，到`Load Balancer`上的`VIP`上，`Load Balancer`就挑选一个`RS`进行响应，但是`Load Balancer`和`RS`并不在同一个网络上，这时候就用到隧道了。

简单来说`IP`隧道技术就是将 `IP`数据包的上面再封装一层`IP`数据包，然后路由器根据最外层的`IP`地址路由到目的地服务器，目的地服务器拆掉最外层的`IP`数据包，拿到里面的`IP`数据包进行处理。

`Load Balancer`是通过隧道进行了信息传输，虽然增加了负载，可是因为地理位置不同的优势，还是可以参考的一种方案。但是，这种方式需要所有的服务器支持`IP Tunneling`(`IP Encapsulation`)协议。

##### 2.4 `LVS`三种模式对比
`IPIP` 模式即 `TUN` 模式。

![](../pic/LVS.jpg)

#### 3. `Nginx`

#### 4. `HAProxy`

#### 5. ``F5``负载均衡器
`F5`负载均衡器是应用交付网络的全球领导者 `F5 Networks` 公司提供的一个负载均衡器专用设备，`F5 BIG-IP LTM` 的官方名称叫做本地流量管理器，可以做4-7层负载均衡，具有负载均衡、应用交换、会话交换、状态监控、智能网络地址转换、通用持续性、响应错误处理、`IPv6`网关、高级路由、智能端口镜像、`SSL`加速、智能`HTTP`压缩、`TCP`优化、第7层速率整形、内容缓冲、内容转换、连接加速、高速缓存、`Cookie`加密、选择性内容加密、应用攻击过滤、拒绝服务(`DoS`)攻击和`SYN Flood`保护、防火墙—包过滤、包消毒等功能。

以下是`F5 BIG-IP`用作`HTTP`负载均衡器的主要功能：

（1）`F5 BIG-IP`提供12种灵活的算法将所有流量均衡的分配到各个服务器，而面对用户，只是一台虚拟服务器。

（2）`F5 BIG-IP`可以确认应用程序能否对请求返回对应的数据。假如`F5 BIG-IP`后面的某一台服务器发生服务停止、死机等故障，`F5`会检查出来并将该服务器标识为宕机，从而不将用户的访问请求传送到该台发生故障的服务器上。这样，只要其它的服务器正常，用户的访问就不会受到影响。宕机一旦修复，`F5 BIG-IP`就会自动查证应用已能对客户请求作出正确响应并恢复向该服务器传送。

（3）`F5 BIG-IP`具有动态`Session`的会话保持功能。

（4）`F5 BIG-IP`的`iRules`功能可以做`HTTP`内容过滤，根据不同的域名、`URL`，将访问请求传送到不同的服务器。

#### 6. `HTTP`重定向
当用户发来请求的时候，`Web`服务器通过修改`HTTP`响应头中的`Location`标记来返回一个新的`url`，然后浏览器再继续请求这个新`url`，实际上就是页面重定向。通过重定向，来达到负载均衡的目标。重定向的`HTTP`返回码是`302`。

优点：比较简单。

缺点：浏览器需要两次请求服务器才能完成一次访问，性能较差，重定向服务自身的处理能力有可能成为瓶颈。

#### 7. 负载均衡算法

+ 轮询 Round Robin

+ 随机 Random

+ 源地址散列 Hash

### 二. 高可用
#### 1. keepalived

### 扩展阅读
#### 1. 负载均衡的原理
微信公众号 [码农翻身](https://mp.weixin.qq.com/s?__biz=MzAxOTc0NzExNg==&mid=2665514539&idx=1&sn=e36b47d93396844bb1a46c82c9b65df7&chksm=80d67e68b7a1f77e80052ea57e4676ea79c5c53b49a038f597ee99dba54ad15d2abdfe36433c&mpshare=1&scene=1&srcid=08140yFzvlCA8KMMUIW3gtTH#rd)

#### 2. LVS三种模式配置及优点缺点比较
https://www.cnblogs.com/lixigang/p/5371816.html
